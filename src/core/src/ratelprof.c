/** THIS FILE HAS BEEN AUTOMATICALLY GENERATED BY THE GILDA TOOL.
 * DO NOT MODIFY UNLESS YOU KNOW WHAT YOU ARE DOING.
 * ANY CHANGES MAY BE OVERWRITTEN BY SUBSEQUENT RUNS OF GILDA.
 */
 
#include <stdio.h>
#include "ratelprof.h"


ratelprof_api_table_t hsa_api_table;
ratelprof_api_table_t omp_tgt_rtl_api_table;
ratelprof_api_table_t omp_routine_api_table;
ratelprof_api_table_t hip_api_table;
ratelprof_api_table_t mpi_api_table;


struct {
    ratelprof_api_table_t* api_table_addr;
    size_t nb_function;
    const char* lib_path;
} domains_info[] = {
{&hsa_api_table, HSA_API_ID_NB_FUNCTION, NULL},
{&omp_tgt_rtl_api_table, OMP_TGT_RTL_API_ID_NB_FUNCTION, "/opt/rocm/llvm/lib/libomptarget.rtl.amdgpu.so"},
{&omp_routine_api_table, OMP_ROUTINE_API_ID_NB_FUNCTION, NULL},
{&hip_api_table, HIP_API_ID_NB_FUNCTION, NULL},
{&mpi_api_table, MPI_API_ID_NB_FUNCTION, NULL},
};


// ---- Internal implementations ----
const char* __ratelprof_get_domain_name_impl(ratelprof_domain_t domain)
{
	switch(domain) {
		case RATELPROF_DOMAIN_HSA          : return RATELPROF_DOMAIN_HSA_NAME;
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : return RATELPROF_DOMAIN_OMP_TGT_RTL_NAME;
		case RATELPROF_DOMAIN_OMP_ROUTINE  : return RATELPROF_DOMAIN_OMP_ROUTINE_NAME;
		case RATELPROF_DOMAIN_HIP          : return RATELPROF_DOMAIN_HIP_NAME;
		case RATELPROF_DOMAIN_MPI          : return RATELPROF_DOMAIN_MPI_NAME;
		default : return "Unknown domain";
	}
	return "Unknown domain";
}


const char* __ratelprof_get_domain_desc_impl(ratelprof_domain_t domain)
{
	switch(domain) {
		case RATELPROF_DOMAIN_HSA          : return RATELPROF_DOMAIN_HSA_DESC;
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : return RATELPROF_DOMAIN_OMP_TGT_RTL_DESC;
		case RATELPROF_DOMAIN_OMP_ROUTINE  : return RATELPROF_DOMAIN_OMP_ROUTINE_DESC;
		case RATELPROF_DOMAIN_HIP          : return RATELPROF_DOMAIN_HIP_DESC;
		case RATELPROF_DOMAIN_MPI          : return RATELPROF_DOMAIN_MPI_DESC;		
        default : return "Unknown domain";
	}
	return "Unknown domain";
}


const char* __ratelprof_get_funame_by_id_impl(ratelprof_domain_t domain, ratelprof_api_id_t funid)
{
    switch (domain) {
		case RATELPROF_DOMAIN_HSA          : return get_hsa_funame_by_id(funid);
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : return get_omp_tgt_rtl_funame_by_id(funid);
		case RATELPROF_DOMAIN_OMP_ROUTINE  : return get_omp_routine_funame_by_id(funid);
		case RATELPROF_DOMAIN_HIP          : return get_hip_funame_by_id(funid);
		case RATELPROF_DOMAIN_MPI          : return get_mpi_funame_by_id(funid);		
        default: break;
    }
    return NULL;
}


ratelprof_api_id_t __ratelprof_get_funid_by_name_impl(ratelprof_domain_t domain, const char* funame)
{
    switch (domain) {
		case RATELPROF_DOMAIN_HSA          : return get_hsa_funid_by_name(funame);
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : return get_omp_tgt_rtl_funid_by_name(funame);
		case RATELPROF_DOMAIN_OMP_ROUTINE  : return get_omp_routine_funid_by_name(funame);
		case RATELPROF_DOMAIN_HIP          : return get_hip_funid_by_name(funame);
		case RATELPROF_DOMAIN_MPI          : return get_mpi_funid_by_name(funame);		
        default: break;
    }
    return -1;
}


void* __ratelprof_get_funaddr_by_id_impl(ratelprof_domain_t domain, ratelprof_api_id_t funid)
{
    switch (domain) {
		case RATELPROF_DOMAIN_HSA          : return get_hsa_funaddr_by_id(funid);
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : return get_omp_tgt_rtl_funaddr_by_id(funid);
		case RATELPROF_DOMAIN_OMP_ROUTINE  : return get_omp_routine_funaddr_by_id(funid);
		case RATELPROF_DOMAIN_HIP          : return get_hip_funaddr_by_id(funid);
		case RATELPROF_DOMAIN_MPI          : return get_mpi_funaddr_by_id(funid);		
        default: break;
    }
    return NULL;
}


ratelprof_status_t __ratelprof_enable_domain_impl(ratelprof_domain_t domain)
{
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    switch (domain) {
		case RATELPROF_DOMAIN_HSA          : status = ratelprof_enable_api_table(&hsa_api_table, "RATELPROF_DOMAIN_HSA_FUNCTIONS_FILTERED", "RATELPROF_DOMAIN_HSA_FILTER_TYPE"); break;
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : status = ratelprof_enable_api_table(&omp_tgt_rtl_api_table, "RATELPROF_DOMAIN_OMP_TGT_RTL_FUNCTIONS_FILTERED", "RATELPROF_DOMAIN_OMP_TGT_RTL_FILTER_TYPE"); break;
		case RATELPROF_DOMAIN_OMP_ROUTINE  : status = ratelprof_enable_api_table(&omp_routine_api_table, "RATELPROF_DOMAIN_OMP_ROUTINE_FUNCTIONS_FILTERED", "RATELPROF_DOMAIN_OMP_ROUTINE_FILTER_TYPE"); break;
		case RATELPROF_DOMAIN_HIP          : status = ratelprof_enable_api_table(&hip_api_table, "RATELPROF_DOMAIN_HIP_FUNCTIONS_FILTERED", "RATELPROF_DOMAIN_HIP_FILTER_TYPE"); break;
		case RATELPROF_DOMAIN_MPI          : status = ratelprof_enable_api_table(&mpi_api_table, "RATELPROF_DOMAIN_MPI_FUNCTIONS_FILTERED", "RATELPROF_DOMAIN_MPI_FILTER_TYPE"); break;	
        default: status = RATELPROF_STATUS_UNKNOWN_DOMAIN;
    }
    return status;
}


ratelprof_status_t __ratelprof_disable_domain_impl(ratelprof_domain_t domain)
{
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    switch (domain) {
		case RATELPROF_DOMAIN_HSA          : status = ratelprof_disable_api_table(&hsa_api_table); break;
		case RATELPROF_DOMAIN_OMP_TGT_RTL  : status = ratelprof_disable_api_table(&omp_tgt_rtl_api_table); break;
		case RATELPROF_DOMAIN_OMP_ROUTINE  : status = ratelprof_disable_api_table(&omp_routine_api_table); break;
		case RATELPROF_DOMAIN_HIP          : status = ratelprof_disable_api_table(&hip_api_table); break;
		case RATELPROF_DOMAIN_MPI          : status = ratelprof_disable_api_table(&mpi_api_table); break;	
        default: status = RATELPROF_STATUS_UNKNOWN_DOMAIN;
    }
    return status;
}


ratelprof_status_t __ratelprof_start_impl(void)
{
    ratelprof_start_lifecycle();
    return RATELPROF_STATUS_SUCCESS;
}


ratelprof_status_t __ratelprof_stop_impl(void)
{
    ratelprof_stop_lifecycle();
    return RATELPROF_STATUS_SUCCESS;
}


ratelprof_status_t __ratelprof_init_impl(unsigned int ndomains)
{
	unsetenv("LD_PRELOAD");
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    RATELPROF_TRY(init_id_system());

	for (int i = 0; i < RATELPROF_NB_DOMAIN; i++)
	{
		RATELPROF_TRY(
			ratelprof_init_api_table(i, domains_info[i].api_table_addr, domains_info[i].nb_function),
			LOG(LOG_LEVEL_ERROR, "Cannot init API table for domain %d. %s (code %d)\n", i, get_error_string(status), status)
		);
		RATELPROF_TRY(
			ratelprof_populate_api_table(domains_info[i].api_table_addr, domains_info[i].lib_path),
			LOG(LOG_LEVEL_ERROR, "Cannot populate API table for domain %d. %s (code %d)\n", i, get_error_string(status), status)
		);
	}
    RATELPROF_TRY(
        init_callback_system(ndomains),
        LOG(LOG_LEVEL_ERROR, "Failed to allocate callback system. %s (code %d)\n", get_error_string(status), status)
    );
        
    return status;
}



ratelprof_status_t __ratelprof_fini_impl(void)
{
    cleanup_id_system();
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    
	for (int i = 0; i < RATELPROF_NB_DOMAIN; i++) {
		RATELPROF_TRY(
			ratelprof_cleanup_api_table(domains_info[i].api_table_addr),
			LOG(LOG_LEVEL_ERROR, "Cannot finalize API table for domain %d. %s (code %d)\n", i, get_error_string(status), status)
		);
	}
    fini_callback_system();
    return status;
}



// ---- Public API ----
RATELPROF_PUBLIC_API
const char* ratelprof_get_domain_name(ratelprof_domain_t domain)
{
    return __ratelprof_get_domain_name_impl(domain);
}

RATELPROF_PUBLIC_API
const char* ratelprof_get_domain_desc(ratelprof_domain_t domain)
{
    return __ratelprof_get_domain_desc_impl(domain);
}

RATELPROF_PUBLIC_API
const char* ratelprof_get_funame_by_id(ratelprof_domain_t domain, ratelprof_api_id_t funid)
{
    return __ratelprof_get_funame_by_id_impl(domain, funid);
}

RATELPROF_PUBLIC_API
ratelprof_api_id_t ratelprof_get_funid_by_name(ratelprof_domain_t domain, const char* funame)
{
    return __ratelprof_get_funid_by_name_impl(domain, funame);
}

RATELPROF_PUBLIC_API
void* ratelprof_get_funaddr_by_id(ratelprof_domain_t domain, ratelprof_api_id_t funid)
{
    return __ratelprof_get_funaddr_by_id_impl(domain, funid);
}

RATELPROF_PUBLIC_API
ratelprof_status_t ratelprof_enable_domain(ratelprof_domain_t domain)
{
    return __ratelprof_enable_domain_impl(domain);
}

RATELPROF_PUBLIC_API
ratelprof_status_t ratelprof_disable_domain(ratelprof_domain_t domain)
{
    return __ratelprof_disable_domain_impl(domain);
}

RATELPROF_PUBLIC_API
ratelprof_status_t ratelprof_start(void)
{
    return __ratelprof_start_impl();
}

RATELPROF_PUBLIC_API
ratelprof_status_t ratelprof_stop(void)
{
    return __ratelprof_stop_impl();
}

RATELPROF_PUBLIC_API
ratelprof_status_t ratelprof_init(void)
{
    return __ratelprof_init_impl(RATELPROF_NB_DOMAIN);
}

RATELPROF_PUBLIC_API
ratelprof_status_t ratelprof_fini(void)
{
    return __ratelprof_fini_impl();
}

