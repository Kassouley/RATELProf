/** THIS FILE HAS BEEN AUTOMATICALLY GENERATED BY THE GILDA TOOL.
 * DO NOT MODIFY UNLESS YOU KNOW WHAT YOU ARE DOING.
 * ANY CHANGES MAY BE OVERWRITTEN BY SUBSEQUENT RUNS OF GILDA. 
 */
 
#include <stdio.h>
#include <stdlib.h>

#include "ratelprof.h"
#include "ratelprof/ratelprof_callback.h"

api_callback_t *ratelprof_on_enter_callbacks = NULL;
api_callback_t *ratelprof_on_exit_callbacks = NULL;

static int _ndomains = 0;

void default_callback_function(ratelprof_domain_t domain, ratelprof_api_id_t id, void* user_activity)
{
    LOG(LOG_LEVEL_WARN, "No callback function has been set for domain ID %d.\n", domain); 
}

ratelprof_status_t init_callback_system(unsigned int ndomains) {
    ratelprof_on_enter_callbacks = (api_callback_t*) malloc(ndomains * sizeof(api_callback_t));
    if (!ratelprof_on_enter_callbacks) return RATELPROF_STATUS_MALLOC_FAILED;
    ratelprof_on_exit_callbacks = (api_callback_t*) malloc(ndomains * sizeof(api_callback_t));
    if (!ratelprof_on_exit_callbacks) return RATELPROF_STATUS_MALLOC_FAILED;

    _ndomains = ndomains;

    for (size_t i = 0; i < ndomains; i++)
    {
        ratelprof_on_enter_callbacks[i] = default_callback_function;
        ratelprof_on_exit_callbacks[i] = default_callback_function;
    }
    return RATELPROF_STATUS_SUCCESS;
}


ratelprof_status_t fini_callback_system() {
    if (!ratelprof_on_enter_callbacks || !ratelprof_on_exit_callbacks) {
        return RATELPROF_STATUS_CALLBACK_SYSTEM_NOT_INIT;
    }
    free(ratelprof_on_enter_callbacks);
    free(ratelprof_on_exit_callbacks);
    return RATELPROF_STATUS_SUCCESS;
}

ratelprof_status_t ratelprof_set_api_callback(ratelprof_domain_t domain, api_callback_handler_t callback_handler) {
    if (!callback_handler.on_enter || !callback_handler.on_exit) {
        return RATELPROF_STATUS_CALLBACK_IS_NULL;
	}
    if (domain < 0 || domain > _ndomains) {
        return RATELPROF_STATUS_UNKNOWN_DOMAIN;
    }
    if (!ratelprof_on_enter_callbacks || !ratelprof_on_exit_callbacks) {
        return RATELPROF_STATUS_CALLBACK_SYSTEM_NOT_INIT;
    }

	ratelprof_on_enter_callbacks[domain] = callback_handler.on_enter;
	ratelprof_on_exit_callbacks[domain] = callback_handler.on_exit;
   
    return RATELPROF_STATUS_SUCCESS;
}

