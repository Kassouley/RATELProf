/** THIS FILE HAS BEEN AUTOMATICALLY GENERATED BY THE GILDA TOOL.
 * DO NOT MODIFY UNLESS YOU KNOW WHAT YOU ARE DOING.
 * ANY CHANGES MAY BE OVERWRITTEN BY SUBSEQUENT RUNS OF GILDA. 
 */
 
#include <inttypes.h>
#include <ratelprof.h>
#include <ratelprof_ext.h>
#include "json_buffer.h"
#include "activity_plugin.h" 
#include "omp_routine_plugin.h"
#include "hsa_plugin.h"
#include "omp_tgt_rtl_plugin.h"
#include "hip_plugin.h" 

typedef struct ratelprof_plugin_s {
	api_callback_handler_t omp_routine_callback_handler;
	api_callback_handler_t hsa_callback_handler;
	api_callback_handler_t omp_tgt_rtl_callback_handler;
	api_callback_handler_t hip_callback_handler; 
	api_callback_handler_t ompt_callback_handler;
    activity_callback_t activity_callback;
    json_buffer_t* json_buffer;
} ratelprof_plugin_t;


static inline void init_json_content(json_buffer_t* json_buffer)
{
    int i = 0;
    add_to_json_buffer(json_buffer, "{\n\t\"domain_id\": {\n");
    for (i = 0; i < RATELPROF_NB_DOMAIN_EXT - 1; i++)
    {
        add_to_json_buffer(json_buffer, "\t\t\"%d\": {\"name\":\"%s\", \"desc\":\"%s\"},\n", i, ratelprof_ext_get_domain_name(i), ratelprof_ext_get_domain_desc(i));
    }
    add_to_json_buffer(json_buffer, "\t\t\"%d\": {\"name\":\"%s\", \"desc\":\"%s\"}\n\t},\n", i, ratelprof_ext_get_domain_name(i), ratelprof_ext_get_domain_desc(i));
    
    add_to_json_buffer(json_buffer, "\t\"phase_id\": {\n");
    add_to_json_buffer(json_buffer, "\t\t\"%d\": \"TOOL_INIT_PHASE\",\n", RATELPROF_IN_TOOL_INIT_PHASE);
    add_to_json_buffer(json_buffer, "\t\t\"%d\": \"CONSTRUCTOR_PHASE\",\n", RATELPROF_IN_CONSTRUCTOR_PHASE);
    add_to_json_buffer(json_buffer, "\t\t\"%d\": \"MAIN_PHASE\",\n", RATELPROF_IN_MAIN_PHASE);
    add_to_json_buffer(json_buffer, "\t\t\"%d\": \"DESTRUCTOR_PHASE\",\n", RATELPROF_IN_DESTRUCTOR_PHASE);
    add_to_json_buffer(json_buffer, "\t\t\"%d\": \"TOOL_FINI_PHASE\"\n\t},\n",RATELPROF_IN_TOOL_FINI_PHASE);
    add_to_json_buffer(json_buffer, "\t\"trace_events\": [\n");
}

static inline void fini_json_content(json_buffer_t* json_buffer)
{
    size_t i = 0;
    ratelprof_lifecycle_t*             lc = ratelprof_get_lifecycle();
    ratelprof_object_tracking_pool_t* pool = ratelprof_object_tracking_pool_get_pool();
    ratelprof_agent_object_t*  agents_list = pool->agents_list;
    size_t                    agents_count = pool->agents_count;

    add_to_json_buffer(json_buffer, "\t],");
    add_to_json_buffer(json_buffer, "\n\t\"lifecycle\": {\n");
    add_to_json_buffer(json_buffer, "\t\t\"tool_init_start\": %lu,\n", ratelprof_get_timestamp_ns(lc->tool_init_start));
    add_to_json_buffer(json_buffer, "\t\t\"constructor_start\": %lu,\n", ratelprof_get_timestamp_ns(lc->constructor_start));
    add_to_json_buffer(json_buffer, "\t\t\"main_start\": %lu,\n", ratelprof_get_timestamp_ns(lc->main_start));
    add_to_json_buffer(json_buffer, "\t\t\"main_stop\": %lu,\n", ratelprof_get_timestamp_ns(lc->main_stop));
    add_to_json_buffer(json_buffer, "\t\t\"destructor_stop\": %lu,\n", ratelprof_get_timestamp_ns(lc->destructor_stop));
    add_to_json_buffer(json_buffer, "\t\t\"tool_init_stop\": %lu\n\t},", ratelprof_get_timestamp_ns(lc->tool_fini_stop));
    add_to_json_buffer(json_buffer, "\n\t\"node_id\": {\n");
    if (agents_list && agents_count > 0) {
        for (i = 0; i < agents_count-1; i++)
        {
        add_to_json_buffer(json_buffer, "\t\t\"%" PRIu64 "\": %" PRIu64 ",\n", agents_list[i], i);
        }
        add_to_json_buffer(json_buffer, "\t\t\"%" PRIu64 "\": %" PRIu64 "\n\t}\n}", agents_list[i], i);
    } else {
        add_to_json_buffer(json_buffer, "\t}\n}");
    }
}

ratelprof_status_t ratelprof_plugin_initialize(ratelprof_plugin_t** plugin) 
{
    ratelprof_plugin_t* p = NULL;
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    if (*plugin != NULL) return RATELPROF_STATUS_PLUGIN_ALREADY_INIT;
    
    p = (ratelprof_plugin_t*)malloc(sizeof(ratelprof_plugin_t));
    if (!p) return RATELPROF_STATUS_MALLOC_FAILED;
    
	p->omp_routine_callback_handler.on_enter = on_enter_omp_routine_callback;
	p->omp_routine_callback_handler.on_exit = on_exit_omp_routine_callback;
	p->hsa_callback_handler.on_enter = on_enter_hsa_callback;
	p->hsa_callback_handler.on_exit = on_exit_hsa_callback;
	p->omp_tgt_rtl_callback_handler.on_enter = on_enter_omp_tgt_rtl_callback;
	p->omp_tgt_rtl_callback_handler.on_exit = on_exit_omp_tgt_rtl_callback;
	p->hip_callback_handler.on_enter = on_enter_hip_callback;
	p->hip_callback_handler.on_exit = on_exit_hip_callback; 
	p->ompt_callback_handler.on_enter = on_enter_ompt_callback;
	p->ompt_callback_handler.on_exit = on_exit_ompt_callback; 

    p->activity_callback = activity_callback; 
    p->json_buffer = (json_buffer_t*) malloc(sizeof(json_buffer_t));
    if (!p->json_buffer) return RATELPROF_STATUS_MALLOC_FAILED;
    status = init_json_buffer(p->json_buffer, get_output_file(), 2048);
    init_json_content(p->json_buffer);
    
    *plugin = p;
    return status;
}

ratelprof_status_t ratelprof_plugin_finalize(ratelprof_plugin_t** plugin) 
{
    ratelprof_plugin_t* p = NULL;
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    
    p = *plugin;
    if (p == NULL) return RATELPROF_STATUS_PLUGIN_IS_NULL;
    
    if (!p->json_buffer) return RATELPROF_STATUS_INVALID_PTR;
    fini_json_content(p->json_buffer);
    
    status = flush_json_buffer(p->json_buffer);
    if (status != RATELPROF_STATUS_SUCCESS) return status;
    
    status = close_json_buffer((*plugin)->json_buffer);
    if (status != RATELPROF_STATUS_SUCCESS) return status;
    
    free(p->json_buffer);

    free(*plugin);
    *plugin = NULL;
    return status;
}

ratelprof_status_t ratelprof_get_api_callback(const ratelprof_plugin_t* plugin, ratelprof_domain_t domain, api_callback_handler_t* callback_handler) 
{
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    switch(domain)
    {
		case RATELPROF_DOMAIN_OMP_ROUTINE: *callback_handler = plugin->omp_routine_callback_handler; break;
		case RATELPROF_DOMAIN_HSA: *callback_handler = plugin->hsa_callback_handler; break;
		case RATELPROF_DOMAIN_OMP_TGT_RTL: *callback_handler = plugin->omp_tgt_rtl_callback_handler; break;
		case RATELPROF_DOMAIN_HIP: *callback_handler = plugin->hip_callback_handler; break; 
		case RATELPROF_DOMAIN_OMP_REGION: *callback_handler = plugin->ompt_callback_handler; break; 
        default: return RATELPROF_STATUS_UNKNOWN_DOMAIN;
    }
    return RATELPROF_STATUS_SUCCESS;
}


ratelprof_status_t ratelprof_get_activity_callback(const ratelprof_plugin_t* plugin, activity_callback_t* activity_callback, void** activity_callback_user_args) 
{
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    if (activity_callback == NULL) return RATELPROF_STATUS_INVALID_PTR;
    if (activity_callback_user_args == NULL) return RATELPROF_STATUS_INVALID_PTR;
    *activity_callback = plugin->activity_callback;
    *activity_callback_user_args = plugin->json_buffer;
    return RATELPROF_STATUS_SUCCESS;
}
