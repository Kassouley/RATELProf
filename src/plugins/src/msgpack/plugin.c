/** THIS FILE HAS BEEN AUTOMATICALLY GENERATED BY THE GILDA TOOL.
 * DO NOT MODIFY UNLESS YOU KNOW WHAT YOU ARE DOING.
 * ANY CHANGES MAY BE OVERWRITTEN BY SUBSEQUENT RUNS OF GILDA. 
 */
 
#include <ratelprof.h>
#include <ratelprof_ext.h>
#include "msgpack.h"
#include "activity_plugin.h" 
#include "omp_routine_plugin.h"
#include "hsa_plugin.h"
#include "omp_tgt_rtl_plugin.h"
#include "hip_plugin.h" 

typedef struct {
    msgpack_buffer_t buffer;
    size_t size;
} plugin_traces_t;

typedef struct ratelprof_plugin_s {
	api_callback_handler_t omp_routine_callback_handler;
	api_callback_handler_t hsa_callback_handler;
	api_callback_handler_t omp_tgt_rtl_callback_handler;
	api_callback_handler_t hip_callback_handler; 
	api_callback_handler_t ompt_callback_handler;

    activity_callback_t activity_callback;
    plugin_traces_t* traces;
} ratelprof_plugin_t;

static inline void write_report(plugin_traces_t* traces)
{
    size_t i = 0;
    msgpack_buffer_t buf;
    msgpack_init(&buf, 0xff, MSGPACK_OVERFLOW_WRITE_TO_FILE, get_output_file());

    // Encode a map of size 5 : ["domain_id", "phase_id", "lifecycle", "node_id", "trace_events"]
    msgpack_encode_map(&buf, 5);

    msgpack_encode_string(&buf, "domain_id");
    msgpack_encode_map(&buf, RATELPROF_NB_DOMAIN_EXT);
    for (i = 0; i < RATELPROF_NB_DOMAIN_EXT; i++)
    {
        msgpack_encode_string(&buf, ratelprof_ext_get_domain_name(i));
        msgpack_encode_map(&buf, 2);
        msgpack_encode_string(&buf, "id");
        msgpack_encode_uint(&buf, i);
        msgpack_encode_string(&buf, "desc");
        msgpack_encode_string(&buf, ratelprof_ext_get_domain_desc(i));
    }
    
    const char* phases_name[RATELPROF_NB_PHASE] = {
        "TOOL_INIT_PHASE",
        "CONSTRUCTOR_PHASE",
        "MAIN_PHASE",
        "DESTRUCTOR_PHASE",
        "TOOL_FINI_PHASE"
    };

    msgpack_encode_string(&buf, "phase_id");
    msgpack_encode_map(&buf, RATELPROF_NB_PHASE);
    for (i = 0; i < RATELPROF_NB_PHASE; i++)
    {
        msgpack_encode_uint(&buf, i);
        msgpack_encode_string(&buf, phases_name[i]);
    }

    ratelprof_lifecycle_t* lc = ratelprof_get_lifecycle();
    
    msgpack_encode_string(&buf, "lifecycle");
    msgpack_encode_map(&buf, 6);
    msgpack_encode_string(&buf, "tool_init_start");
    msgpack_encode_uint(&buf, ratelprof_get_timestamp_ns(lc->tool_init_start));
    msgpack_encode_string(&buf, "constructor_start");
    msgpack_encode_uint(&buf, ratelprof_get_timestamp_ns(lc->constructor_start));
    msgpack_encode_string(&buf, "main_start");
    msgpack_encode_uint(&buf, ratelprof_get_timestamp_ns(lc->main_start));
    msgpack_encode_string(&buf, "main_stop");
    msgpack_encode_uint(&buf, ratelprof_get_timestamp_ns(lc->main_stop));
    msgpack_encode_string(&buf, "destructor_stop");
    msgpack_encode_uint(&buf, ratelprof_get_timestamp_ns(lc->destructor_stop));
    msgpack_encode_string(&buf, "tool_init_stop");
    msgpack_encode_uint(&buf, ratelprof_get_timestamp_ns(lc->tool_fini_stop));

    
    ratelprof_object_tracking_pool_t* pool = ratelprof_object_tracking_pool_get_pool();
    ratelprof_agent_object_t*  agents_list = pool->agents_list;
    size_t                     agents_count = pool->agents_count;

    msgpack_encode_string(&buf, "node_id");
    if (agents_list && agents_count > 0) {
        msgpack_encode_map(&buf, agents_count);
        for (i = 0; i < agents_count; i++) {
            msgpack_encode_uint(&buf, agents_list[i].handle);
            msgpack_encode_uint(&buf, i);
        }
    } else {
        msgpack_encode_map(&buf, 0);
    }

    size_t nb_domain_util = 0;
    for (i = 0; i < RATELPROF_NB_DOMAIN_EXT; i++) {
        if (traces[i].size != 0)
            nb_domain_util++;
    }
    msgpack_encode_string(&buf, "trace_events");
    msgpack_encode_map(&buf, nb_domain_util);
    for (i = 0; i < RATELPROF_NB_DOMAIN_EXT; i++) {
        if (traces[i].size != 0) {
            msgpack_encode_uint(&buf, i);
            msgpack_encode_map(&buf, traces[i].size);
            msgpack_concat(&buf, &traces[i].buffer);
            msgpack_free(&traces[i].buffer);
        }
    }
    msgpack_free(&buf);
}



ratelprof_status_t ratelprof_plugin_initialize(ratelprof_plugin_t** plugin) 
{
    ratelprof_plugin_t* p = NULL;
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    if (*plugin != NULL) return RATELPROF_STATUS_PLUGIN_ALREADY_INIT;
    
    p = (ratelprof_plugin_t*)malloc(sizeof(ratelprof_plugin_t));
    if (!p) return RATELPROF_STATUS_MALLOC_FAILED;
    
	p->omp_routine_callback_handler.on_enter = on_enter_omp_routine_callback;
	p->omp_routine_callback_handler.on_exit = on_exit_omp_routine_callback;
	p->hsa_callback_handler.on_enter = on_enter_hsa_callback;
	p->hsa_callback_handler.on_exit = on_exit_hsa_callback;
	p->omp_tgt_rtl_callback_handler.on_enter = on_enter_omp_tgt_rtl_callback;
	p->omp_tgt_rtl_callback_handler.on_exit = on_exit_omp_tgt_rtl_callback;
	p->hip_callback_handler.on_enter = on_enter_hip_callback;
	p->hip_callback_handler.on_exit = on_exit_hip_callback; 
	p->ompt_callback_handler.on_enter = on_enter_ompt_callback;
	p->ompt_callback_handler.on_exit = on_exit_ompt_callback; 

     p->activity_callback = activity_callback; 
    p->traces = (plugin_traces_t*)malloc(RATELPROF_NB_DOMAIN_EXT * sizeof(plugin_traces_t));
    for (int i = 0; i < RATELPROF_NB_DOMAIN_EXT; i++) {
        p->traces[i].size = 0;
        const char* domain_name = ratelprof_ext_get_domain_name(i);
        if (is_set_domain(domain_name)) {
            msgpack_init(&p->traces[i].buffer, 0xffffff, MSGPACK_OVERFLOW_REALLOC, NULL);
        }
    }

    *plugin = p;
    return status;
}

ratelprof_status_t ratelprof_plugin_finalize(ratelprof_plugin_t** plugin) 
{
    ratelprof_plugin_t* p = NULL;
    ratelprof_status_t status = RATELPROF_STATUS_SUCCESS;
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    
    p = *plugin;
    if (p == NULL) return RATELPROF_STATUS_PLUGIN_IS_NULL;
    
    write_report(p->traces);

    free(p->traces);

    free(*plugin);
    *plugin = NULL;
    return status;
}

ratelprof_status_t ratelprof_get_api_callback(const ratelprof_plugin_t* plugin, ratelprof_domain_t domain, api_callback_handler_t* callback_handler) 
{
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    switch(domain)
    {
		case RATELPROF_DOMAIN_OMP_ROUTINE: *callback_handler = plugin->omp_routine_callback_handler; break;
		case RATELPROF_DOMAIN_HSA: *callback_handler = plugin->hsa_callback_handler; break;
		case RATELPROF_DOMAIN_OMP_TGT_RTL: *callback_handler = plugin->omp_tgt_rtl_callback_handler; break;
		case RATELPROF_DOMAIN_HIP: *callback_handler = plugin->hip_callback_handler; break; 
		case RATELPROF_DOMAIN_OMP_REGION: *callback_handler = plugin->ompt_callback_handler; break; 
        default: return RATELPROF_STATUS_UNKNOWN_DOMAIN;
    }
    return RATELPROF_STATUS_SUCCESS;
}


ratelprof_status_t ratelprof_get_activity_callback(const ratelprof_plugin_t* plugin, activity_callback_t* activity_callback, void** activity_callback_user_args) 
{
    if (plugin == NULL) return RATELPROF_STATUS_INVALID_PTR;
    if (activity_callback == NULL) return RATELPROF_STATUS_INVALID_PTR;
    if (activity_callback_user_args == NULL) return RATELPROF_STATUS_INVALID_PTR;
    *activity_callback = plugin->activity_callback;
    *activity_callback_user_args = plugin->traces;
    return RATELPROF_STATUS_SUCCESS;
}
